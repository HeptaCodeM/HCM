<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.hcm.grw.model.mapper.doc.ApprDenyDaoImpl">

	
	<!-- 결재승인 json 데이터 업데이트 + 문서 업데이트 트랜잭션 -->

<!-- 	<update id="approveJson">

		UPDATE SIGN_DOC_BOX
		SET SIDB_DOC_JSON =
		JSON_TRANSFORM(
		SIDB_DOC_JSON,
		SET '$[0].APPR_FLAG' = '1'
		)
		WHERE
		SIDB_DOC_NUM = #{sidb_doc_num}
	</update> -->
	
<!-- 	<update id="approveJson">
    UPDATE SIGN_DOC_BOX
    SET SIDB_DOC_JSON = JSON_TRANSFORM(
        SIDB_DOC_JSON,
        <foreach collection="sidb_doc_json" separator="," item="json">
        SET '$[0].APPR_DT' = '' || TO_CHAR(CURRENT_DATE, 'YYYY-MM-DD') || '',
            '$[0].APPR_REPLY' = "${json.appr_reply}",
            '$[0].APPR_FLAG' = '1',
            '$[0].APPR_SIGN' = '' || (SELECT EMSI_SIGN_IMG FROM EMP_SIGN
                                        WHERE EMSI_SEQ = 1) || '')
                                        </foreach>
    WHERE SIDB_DOC_NUM = #{sidb_doc_num}
</update> -->

	<update id="approveJson">
    UPDATE SIGN_DOC_BOX
    SET SIDB_DOC_JSON = JSON_TRANSFORM(
        SIDB_DOC_JSON,
        SET '$[${string_index}].APPR_DT' = '' || TO_CHAR(CURRENT_DATE, 'YYYY-MM-DD') || '',
            '$[${string_index}].APPR_REPLY' = #{appr_reply},
            '$[${string_index}].APPR_FLAG' = '1',
            '$[${string_index}].APPR_SIGN' = '' || (SELECT EMSI_SIGN_IMG FROM EMP_SIGN
                                        WHERE EMSI_SEQ = #{emsi_seq}) || '')
    WHERE SIDB_DOC_NUM = #{sidb_doc_num}
</update>

	<update id="approveDoc">

		UPDATE SIGN_DOC_BOX
		SET SIDB_DOC_APPRDT = CURRENT_DATE, SIDB_DOC_STAT = '2'
		WHERE
		SIDB_DOC_NUM = #{sidb_doc_num}

	</update>

<!-- 결재반려 json 데이터 업데이트 + 문서 업데이트 트랜잭션 -->
	
  
<update id="denyJson" >
  
    UPDATE SIGN_DOC_BOX
    SET SIDB_DOC_JSON = JSON_TRANSFORM(
        SIDB_DOC_JSON,
        SET '$[${string_index}].APPR_DT' = '' || TO_CHAR(CURRENT_DATE, 'YYYY-MM-DD') || '',
            '$[${string_index}].APPR_REPLY' = #{appr_reply},
            '$[${string_index}].APPR_FLAG' = '3')
    WHERE SIDB_DOC_NUM = #{sidb_doc_num}
</update>

	<update id="denyDoc">

		UPDATE SIGN_DOC_BOX
		SET SIDB_DOC_STAT = '4'
		WHERE
		SIDB_DOC_NUM = #{sidb_doc_num}

	</update>


<!-- 최종승인 json 데이터 업데이트 + 문서 업데이트 트랜잭션 -->
	<update id="finalJsonApprove">
		UPDATE SIGN_DOC_BOX
		SET
		SIDB_DOC_JSON = JSON_TRANSFORM(
		SIDB_DOC_JSON,
		SET '$[2].APPR_FLAG' =
		'1'
		)
		WHERE SIDB_DOC_NUM = #{sidb_doc_num}
	</update>

	<update id="finalDocApprove">
		UPDATE SIGN_DOC_BOX
		SET SIDB_DOC_STAT = '3'
		WHERE SIDB_DOC_NUM = #{sidb_doc_num}
	</update>
</mapper>
